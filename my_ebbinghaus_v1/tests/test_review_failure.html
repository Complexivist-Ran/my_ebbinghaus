<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤ä¹ å¤±è´¥é€»è¾‘æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .test-result { margin: 10px 0; padding: 10px; }
        .pass { background-color: #d4edda; color: #155724; }
        .fail { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button { padding: 8px 16px; margin: 5px; }
        table { border-collapse: collapse; width: 100%; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>å¤ä¹ å¤±è´¥é€»è¾‘æµ‹è¯•</h1>
    <p>æµ‹è¯•å¤ä¹ å¤±è´¥åçŸ¥è¯†ç‚¹æ˜¯å¦ä»ç„¶å‡ºç°åœ¨å½“å¤©å¤ä¹ é˜Ÿåˆ—ä¸­</p>
    
    <div class="test-section">
        <h2>1. åˆ›å»ºæµ‹è¯•çŸ¥è¯†ç‚¹</h2>
        <button onclick="createTestPoints()">åˆ›å»ºæµ‹è¯•çŸ¥è¯†ç‚¹</button>
        <div id="create-results"></div>
    </div>
    
    <div class="test-section">
        <h2>2. æ£€æŸ¥åˆå§‹å¤ä¹ é˜Ÿåˆ—</h2>
        <button onclick="checkInitialQueue()">æ£€æŸ¥åˆå§‹å¤ä¹ é˜Ÿåˆ—</button>
        <div id="initial-results"></div>
    </div>
    
    <div class="test-section">
        <h2>3. æ¨¡æ‹Ÿå¤ä¹ å¤±è´¥</h2>
        <button onclick="simulateReviewFailure()">æ¨¡æ‹Ÿå¤ä¹ å¤±è´¥</button>
        <div id="failure-results"></div>
    </div>
    
    <div class="test-section">
        <h2>4. éªŒè¯å¤ä¹ å¤±è´¥åçš„çŠ¶æ€</h2>
        <button onclick="verifyAfterFailure()">éªŒè¯å¤±è´¥åçŠ¶æ€</button>
        <div id="verify-results"></div>
    </div>
    
    <div class="test-section">
        <h2>5. æµ‹è¯•æ‰€æœ‰æŒæ¡ç¨‹åº¦çš„å¤ä¹ å¤±è´¥</h2>
        <button onclick="testAllFailureScenarios()">æµ‹è¯•æ‰€æœ‰å¤±è´¥åœºæ™¯</button>
        <div id="all-tests-results"></div>
    </div>
    
    <div class="test-section">
        <h2>6. æ¸…ç†æµ‹è¯•æ•°æ®</h2>
        <button onclick="clearTestData()">æ¸…ç†æ•°æ®</button>
        <div id="cleanup-results"></div>
    </div>
    
    <script src="../src/js/ebbinghaus.js"></script>
    <script src="../src/js/storage.js"></script>
    <script>
        let testPointIds = [];
        
        function createTestPoints() {
            const results = document.getElementById('create-results');
            results.innerHTML = '<h3>åˆ›å»ºæµ‹è¯•çŸ¥è¯†ç‚¹ï¼š</h3>';
            
            try {
                // æ¸…ç†ç°æœ‰æ•°æ®
                localStorage.removeItem('my_ebbinghaus_knowledge_points');
                testPointIds = [];
                
                // åˆ›å»ºä¸åŒæŒæ¡ç¨‹åº¦çš„çŸ¥è¯†ç‚¹
                const testPoints = [
                    {
                        title: 'æŒæ¡ç­‰çº§çŸ¥è¯†ç‚¹',
                        content: 'è¿™æ˜¯ä¸€ä¸ªæŒæ¡ç­‰çº§çš„çŸ¥è¯†ç‚¹',
                        masteryLevel: 'mastered',
                        tags: ['æµ‹è¯•', 'æŒæ¡']
                    },
                    {
                        title: 'å­¦ä¹ ä¸­ç­‰çº§çŸ¥è¯†ç‚¹',
                        content: 'è¿™æ˜¯ä¸€ä¸ªå­¦ä¹ ä¸­ç­‰çº§çš„çŸ¥è¯†ç‚¹',
                        masteryLevel: 'learning',
                        tags: ['æµ‹è¯•', 'å­¦ä¹ ä¸­']
                    },
                    {
                        title: 'å›°éš¾ç­‰çº§çŸ¥è¯†ç‚¹',
                        content: 'è¿™æ˜¯ä¸€ä¸ªå›°éš¾ç­‰çº§çš„çŸ¥è¯†ç‚¹',
                        masteryLevel: 'struggling',
                        tags: ['æµ‹è¯•', 'å›°éš¾']
                    }
                ];
                
                testPoints.forEach(point => {
                    const created = addKnowledgePoint(point.title, point.content, point.tags, point.masteryLevel);
                    testPointIds.push(created.id);
                    results.innerHTML += `<div class="test-result info">âœ… åˆ›å»ºï¼š${created.title} (${created.masteryLevel}) - ä¸‹æ¬¡å¤ä¹ ï¼š${created.nextReview}</div>`;
                });
                
                results.innerHTML += `<div class="test-result pass">âœ… æˆåŠŸåˆ›å»º ${testPointIds.length} ä¸ªæµ‹è¯•çŸ¥è¯†ç‚¹</div>`;
                
            } catch (error) {
                results.innerHTML += `<div class="test-result fail">âŒ åˆ›å»ºå¤±è´¥ï¼š${error.message}</div>`;
            }
        }
        
        function checkInitialQueue() {
            const results = document.getElementById('initial-results');
            results.innerHTML = '<h3>æ£€æŸ¥åˆå§‹å¤ä¹ é˜Ÿåˆ—ï¼š</h3>';
            
            try {
                const pointsToReview = getPointsToReview();
                const today = getTodayString();
                
                results.innerHTML += `<div class="test-result info">ğŸ“… ä»Šå¤©æ—¥æœŸï¼š${today}</div>`;
                results.innerHTML += `<div class="test-result info">ğŸ“Š éœ€è¦å¤ä¹ çš„çŸ¥è¯†ç‚¹æ•°é‡ï¼š${pointsToReview.length}</div>`;
                
                if (pointsToReview.length > 0) {
                    results.innerHTML += '<div class="test-result pass">âœ… ä»Šå¤©æœ‰éœ€è¦å¤ä¹ çš„çŸ¥è¯†ç‚¹</div>';
                    pointsToReview.forEach(point => {
                        results.innerHTML += `<div class="test-result info">ğŸ“ ${point.title} (${point.masteryLevel}) - å¤ä¹ æ¬¡æ•°ï¼š${point.reviewCount}</div>`;
                    });
                } else {
                    results.innerHTML += '<div class="test-result fail">âŒ ä»Šå¤©æ²¡æœ‰éœ€è¦å¤ä¹ çš„çŸ¥è¯†ç‚¹</div>';
                }
                
            } catch (error) {
                results.innerHTML += `<div class="test-result fail">âŒ æ£€æŸ¥å¤±è´¥ï¼š${error.message}</div>`;
            }
        }
        
        function simulateReviewFailure() {
            const results = document.getElementById('failure-results');
            results.innerHTML = '<h3>æ¨¡æ‹Ÿå¤ä¹ å¤±è´¥ï¼š</h3>';
            
            try {
                const pointsToReview = getPointsToReview();
                
                if (pointsToReview.length === 0) {
                    results.innerHTML += '<div class="test-result fail">âŒ æ²¡æœ‰çŸ¥è¯†ç‚¹éœ€è¦å¤ä¹ </div>';
                    return;
                }
                
                // é€‰æ‹©ç¬¬ä¸€ä¸ªçŸ¥è¯†ç‚¹è¿›è¡Œå¤ä¹ å¤±è´¥æµ‹è¯•
                const testPoint = pointsToReview[0];
                results.innerHTML += `<div class="test-result info">ğŸ“ æµ‹è¯•çŸ¥è¯†ç‚¹ï¼š${testPoint.title} (${testPoint.masteryLevel})</div>`;
                results.innerHTML += `<div class="test-result info">ğŸ“Š å¤ä¹ å‰çŠ¶æ€ï¼šå¤ä¹ æ¬¡æ•°=${testPoint.reviewCount}, ä¸‹æ¬¡å¤ä¹ =${testPoint.nextReview}</div>`;
                
                // æ¨¡æ‹Ÿå¤ä¹ å¤±è´¥
                const newMasteryLevel = processReviewResult(testPoint.masteryLevel, 'failure');
                const nextReviewDate = calculateNextReviewDate(newMasteryLevel, getTodayString(), 0);
                
                updateKnowledgePoint(testPoint.id, {
                    masteryLevel: newMasteryLevel,
                    nextReview: nextReviewDate,
                    reviewCount: 0
                });
                
                results.innerHTML += `<div class="test-result info">ğŸ“ˆ å¤ä¹ å¤±è´¥åï¼šæŒæ¡ç¨‹åº¦=${newMasteryLevel}, å¤ä¹ æ¬¡æ•°=0, ä¸‹æ¬¡å¤ä¹ =${nextReviewDate}</div>`;
                results.innerHTML += '<div class="test-result pass">âœ… å¤ä¹ å¤±è´¥å¤„ç†å®Œæˆ</div>';
                
            } catch (error) {
                results.innerHTML += `<div class="test-result fail">âŒ æ¨¡æ‹Ÿå¤±è´¥ï¼š${error.message}</div>`;
            }
        }
        
        function verifyAfterFailure() {
            const results = document.getElementById('verify-results');
            results.innerHTML = '<h3>éªŒè¯å¤ä¹ å¤±è´¥åçš„çŠ¶æ€ï¼š</h3>';
            
            try {
                const pointsToReview = getPointsToReview();
                const today = getTodayString();
                
                results.innerHTML += `<div class="test-result info">ğŸ“… ä»Šå¤©æ—¥æœŸï¼š${today}</div>`;
                results.innerHTML += `<div class="test-result info">ğŸ“Š éœ€è¦å¤ä¹ çš„çŸ¥è¯†ç‚¹æ•°é‡ï¼š${pointsToReview.length}</div>`;
                
                if (pointsToReview.length > 0) {
                    results.innerHTML += '<div class="test-result pass">âœ… å¤ä¹ å¤±è´¥åï¼ŒçŸ¥è¯†ç‚¹ä»ç„¶åœ¨å½“å¤©å¤ä¹ é˜Ÿåˆ—ä¸­</div>';
                    
                    pointsToReview.forEach(point => {
                        results.innerHTML += `<div class="test-result info">ğŸ“ ${point.title} (${point.masteryLevel}) - å¤ä¹ æ¬¡æ•°ï¼š${point.reviewCount} - ä¸‹æ¬¡å¤ä¹ ï¼š${point.nextReview}</div>`;
                    });
                } else {
                    results.innerHTML += '<div class="test-result fail">âŒ å¤ä¹ å¤±è´¥åï¼ŒçŸ¥è¯†ç‚¹ä¸åœ¨å½“å¤©å¤ä¹ é˜Ÿåˆ—ä¸­</div>';
                }
                
            } catch (error) {
                results.innerHTML += `<div class="test-result fail">âŒ éªŒè¯å¤±è´¥ï¼š${error.message}</div>`;
            }
        }
        
        function testAllFailureScenarios() {
            const results = document.getElementById('all-tests-results');
            results.innerHTML = '<h3>æµ‹è¯•æ‰€æœ‰æŒæ¡ç¨‹åº¦çš„å¤ä¹ å¤±è´¥ï¼š</h3>';
            
            try {
                const today = getTodayString();
                
                results.innerHTML += '<table><tr><th>æŒæ¡ç¨‹åº¦</th><th>å¤±è´¥åæŒæ¡ç¨‹åº¦</th><th>å¤±è´¥åå¤ä¹ æ—¶é—´</th><th>æ˜¯å¦å½“å¤©å¤ä¹ </th><th>ç»“æœ</th></tr>';
                
                const testCases = [
                    { level: 'mastered', expected: 'learning', expectedReview: 'tomorrow' },
                    { level: 'learning', expected: 'struggling', expectedReview: 'today' },
                    { level: 'struggling', expected: 'struggling', expectedReview: 'today' }
                ];
                
                testCases.forEach(testCase => {
                    // åˆ›å»ºæµ‹è¯•çŸ¥è¯†ç‚¹
                    const testPoint = addKnowledgePoint(
                        `æµ‹è¯•${testCase.level}`,
                        `æµ‹è¯•${testCase.level}ç­‰çº§çš„å¤ä¹ å¤±è´¥`,
                        ['æµ‹è¯•'],
                        testCase.level
                    );
                    
                    // æ¨¡æ‹Ÿå¤ä¹ å¤±è´¥
                    const newMasteryLevel = processReviewResult(testCase.level, 'failure');
                    const nextReviewDate = calculateNextReviewDate(newMasteryLevel, getTodayString(), 0);
                    
                    updateKnowledgePoint(testPoint.id, {
                        masteryLevel: newMasteryLevel,
                        nextReview: nextReviewDate,
                        reviewCount: 0
                    });
                    
                    // éªŒè¯ç»“æœ
                    const isTodayReview = nextReviewDate === today;
                    const passed = newMasteryLevel === testCase.expected && 
                                 ((testCase.expectedReview === 'today' && isTodayReview) || 
                                  (testCase.expectedReview === 'tomorrow' && !isTodayReview));
                    
                    results.innerHTML += `
                        <tr>
                            <td>${testCase.level}</td>
                            <td>${newMasteryLevel}</td>
                            <td>${nextReviewDate}</td>
                            <td>${isTodayReview ? 'æ˜¯' : 'å¦'}</td>
                            <td>${passed ? 'âœ…' : 'âŒ'}</td>
                        </tr>
                    `;
                });
                
                results.innerHTML += '</table>';
                
            } catch (error) {
                results.innerHTML += `<div class="test-result fail">âŒ æµ‹è¯•å¤±è´¥ï¼š${error.message}</div>`;
            }
        }
        
        function clearTestData() {
            const results = document.getElementById('cleanup-results');
            results.innerHTML = '<h3>æ¸…ç†æµ‹è¯•æ•°æ®ï¼š</h3>';
            
            try {
                localStorage.removeItem('my_ebbinghaus_knowledge_points');
                localStorage.removeItem('my_ebbinghaus_settings');
                testPointIds = [];
                results.innerHTML += '<div class="test-result pass">âœ… æµ‹è¯•æ•°æ®æ¸…ç†å®Œæˆ</div>';
            } catch (error) {
                results.innerHTML += `<div class="test-result fail">âŒ æ¸…ç†å¤±è´¥ï¼š${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
