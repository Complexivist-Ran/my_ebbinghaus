<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>复习失败逻辑测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .test-result { margin: 10px 0; padding: 10px; }
        .pass { background-color: #d4edda; color: #155724; }
        .fail { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button { padding: 8px 16px; margin: 5px; }
        table { border-collapse: collapse; width: 100%; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>复习失败逻辑测试</h1>
    <p>测试复习失败后知识点是否仍然出现在当天复习队列中</p>
    
    <div class="test-section">
        <h2>1. 创建测试知识点</h2>
        <button onclick="createTestPoints()">创建测试知识点</button>
        <div id="create-results"></div>
    </div>
    
    <div class="test-section">
        <h2>2. 检查初始复习队列</h2>
        <button onclick="checkInitialQueue()">检查初始复习队列</button>
        <div id="initial-results"></div>
    </div>
    
    <div class="test-section">
        <h2>3. 模拟复习失败</h2>
        <button onclick="simulateReviewFailure()">模拟复习失败</button>
        <div id="failure-results"></div>
    </div>
    
    <div class="test-section">
        <h2>4. 验证复习失败后的状态</h2>
        <button onclick="verifyAfterFailure()">验证失败后状态</button>
        <div id="verify-results"></div>
    </div>
    
    <div class="test-section">
        <h2>5. 测试所有掌握程度的复习失败</h2>
        <button onclick="testAllFailureScenarios()">测试所有失败场景</button>
        <div id="all-tests-results"></div>
    </div>
    
    <div class="test-section">
        <h2>6. 清理测试数据</h2>
        <button onclick="clearTestData()">清理数据</button>
        <div id="cleanup-results"></div>
    </div>
    
    <script src="../src/js/ebbinghaus.js"></script>
    <script src="../src/js/storage.js"></script>
    <script>
        let testPointIds = [];
        
        function createTestPoints() {
            const results = document.getElementById('create-results');
            results.innerHTML = '<h3>创建测试知识点：</h3>';
            
            try {
                // 清理现有数据
                localStorage.removeItem('my_ebbinghaus_knowledge_points');
                testPointIds = [];
                
                // 创建不同掌握程度的知识点
                const testPoints = [
                    {
                        title: '掌握等级知识点',
                        content: '这是一个掌握等级的知识点',
                        masteryLevel: 'mastered',
                        tags: ['测试', '掌握']
                    },
                    {
                        title: '学习中等级知识点',
                        content: '这是一个学习中等级的知识点',
                        masteryLevel: 'learning',
                        tags: ['测试', '学习中']
                    },
                    {
                        title: '困难等级知识点',
                        content: '这是一个困难等级的知识点',
                        masteryLevel: 'struggling',
                        tags: ['测试', '困难']
                    }
                ];
                
                testPoints.forEach(point => {
                    const created = addKnowledgePoint(point.title, point.content, point.tags, point.masteryLevel);
                    testPointIds.push(created.id);
                    results.innerHTML += `<div class="test-result info">✅ 创建：${created.title} (${created.masteryLevel}) - 下次复习：${created.nextReview}</div>`;
                });
                
                results.innerHTML += `<div class="test-result pass">✅ 成功创建 ${testPointIds.length} 个测试知识点</div>`;
                
            } catch (error) {
                results.innerHTML += `<div class="test-result fail">❌ 创建失败：${error.message}</div>`;
            }
        }
        
        function checkInitialQueue() {
            const results = document.getElementById('initial-results');
            results.innerHTML = '<h3>检查初始复习队列：</h3>';
            
            try {
                const pointsToReview = getPointsToReview();
                const today = getTodayString();
                
                results.innerHTML += `<div class="test-result info">📅 今天日期：${today}</div>`;
                results.innerHTML += `<div class="test-result info">📊 需要复习的知识点数量：${pointsToReview.length}</div>`;
                
                if (pointsToReview.length > 0) {
                    results.innerHTML += '<div class="test-result pass">✅ 今天有需要复习的知识点</div>';
                    pointsToReview.forEach(point => {
                        results.innerHTML += `<div class="test-result info">📝 ${point.title} (${point.masteryLevel}) - 复习次数：${point.reviewCount}</div>`;
                    });
                } else {
                    results.innerHTML += '<div class="test-result fail">❌ 今天没有需要复习的知识点</div>';
                }
                
            } catch (error) {
                results.innerHTML += `<div class="test-result fail">❌ 检查失败：${error.message}</div>`;
            }
        }
        
        function simulateReviewFailure() {
            const results = document.getElementById('failure-results');
            results.innerHTML = '<h3>模拟复习失败：</h3>';
            
            try {
                const pointsToReview = getPointsToReview();
                
                if (pointsToReview.length === 0) {
                    results.innerHTML += '<div class="test-result fail">❌ 没有知识点需要复习</div>';
                    return;
                }
                
                // 选择第一个知识点进行复习失败测试
                const testPoint = pointsToReview[0];
                results.innerHTML += `<div class="test-result info">📝 测试知识点：${testPoint.title} (${testPoint.masteryLevel})</div>`;
                results.innerHTML += `<div class="test-result info">📊 复习前状态：复习次数=${testPoint.reviewCount}, 下次复习=${testPoint.nextReview}</div>`;
                
                // 模拟复习失败
                const newMasteryLevel = processReviewResult(testPoint.masteryLevel, 'failure');
                const nextReviewDate = calculateNextReviewDate(newMasteryLevel, getTodayString(), 0);
                
                updateKnowledgePoint(testPoint.id, {
                    masteryLevel: newMasteryLevel,
                    nextReview: nextReviewDate,
                    reviewCount: 0
                });
                
                results.innerHTML += `<div class="test-result info">📈 复习失败后：掌握程度=${newMasteryLevel}, 复习次数=0, 下次复习=${nextReviewDate}</div>`;
                results.innerHTML += '<div class="test-result pass">✅ 复习失败处理完成</div>';
                
            } catch (error) {
                results.innerHTML += `<div class="test-result fail">❌ 模拟失败：${error.message}</div>`;
            }
        }
        
        function verifyAfterFailure() {
            const results = document.getElementById('verify-results');
            results.innerHTML = '<h3>验证复习失败后的状态：</h3>';
            
            try {
                const pointsToReview = getPointsToReview();
                const today = getTodayString();
                
                results.innerHTML += `<div class="test-result info">📅 今天日期：${today}</div>`;
                results.innerHTML += `<div class="test-result info">📊 需要复习的知识点数量：${pointsToReview.length}</div>`;
                
                if (pointsToReview.length > 0) {
                    results.innerHTML += '<div class="test-result pass">✅ 复习失败后，知识点仍然在当天复习队列中</div>';
                    
                    pointsToReview.forEach(point => {
                        results.innerHTML += `<div class="test-result info">📝 ${point.title} (${point.masteryLevel}) - 复习次数：${point.reviewCount} - 下次复习：${point.nextReview}</div>`;
                    });
                } else {
                    results.innerHTML += '<div class="test-result fail">❌ 复习失败后，知识点不在当天复习队列中</div>';
                }
                
            } catch (error) {
                results.innerHTML += `<div class="test-result fail">❌ 验证失败：${error.message}</div>`;
            }
        }
        
        function testAllFailureScenarios() {
            const results = document.getElementById('all-tests-results');
            results.innerHTML = '<h3>测试所有掌握程度的复习失败：</h3>';
            
            try {
                const today = getTodayString();
                
                results.innerHTML += '<table><tr><th>掌握程度</th><th>失败后掌握程度</th><th>失败后复习时间</th><th>是否当天复习</th><th>结果</th></tr>';
                
                const testCases = [
                    { level: 'mastered', expected: 'learning', expectedReview: 'tomorrow' },
                    { level: 'learning', expected: 'struggling', expectedReview: 'today' },
                    { level: 'struggling', expected: 'struggling', expectedReview: 'today' }
                ];
                
                testCases.forEach(testCase => {
                    // 创建测试知识点
                    const testPoint = addKnowledgePoint(
                        `测试${testCase.level}`,
                        `测试${testCase.level}等级的复习失败`,
                        ['测试'],
                        testCase.level
                    );
                    
                    // 模拟复习失败
                    const newMasteryLevel = processReviewResult(testCase.level, 'failure');
                    const nextReviewDate = calculateNextReviewDate(newMasteryLevel, getTodayString(), 0);
                    
                    updateKnowledgePoint(testPoint.id, {
                        masteryLevel: newMasteryLevel,
                        nextReview: nextReviewDate,
                        reviewCount: 0
                    });
                    
                    // 验证结果
                    const isTodayReview = nextReviewDate === today;
                    const passed = newMasteryLevel === testCase.expected && 
                                 ((testCase.expectedReview === 'today' && isTodayReview) || 
                                  (testCase.expectedReview === 'tomorrow' && !isTodayReview));
                    
                    results.innerHTML += `
                        <tr>
                            <td>${testCase.level}</td>
                            <td>${newMasteryLevel}</td>
                            <td>${nextReviewDate}</td>
                            <td>${isTodayReview ? '是' : '否'}</td>
                            <td>${passed ? '✅' : '❌'}</td>
                        </tr>
                    `;
                });
                
                results.innerHTML += '</table>';
                
            } catch (error) {
                results.innerHTML += `<div class="test-result fail">❌ 测试失败：${error.message}</div>`;
            }
        }
        
        function clearTestData() {
            const results = document.getElementById('cleanup-results');
            results.innerHTML = '<h3>清理测试数据：</h3>';
            
            try {
                localStorage.removeItem('my_ebbinghaus_knowledge_points');
                localStorage.removeItem('my_ebbinghaus_settings');
                testPointIds = [];
                results.innerHTML += '<div class="test-result pass">✅ 测试数据清理完成</div>';
            } catch (error) {
                results.innerHTML += `<div class="test-result fail">❌ 清理失败：${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
