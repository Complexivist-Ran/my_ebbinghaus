<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>导出功能测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .test-result { margin: 10px 0; padding: 10px; }
        .pass { background-color: #d4edda; color: #155724; }
        .fail { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button { padding: 8px 16px; margin: 5px; }
        textarea { width: 100%; height: 300px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>导出功能测试</h1>
    
    <div class="test-section">
        <h2>1. 创建测试数据</h2>
        <button onclick="createTestData()">创建测试知识点</button>
        <div id="create-results"></div>
    </div>
    
    <div class="test-section">
        <h2>2. 测试导出功能</h2>
        <button onclick="testExport()">测试导出</button>
        <div id="export-results"></div>
    </div>
    
    <div class="test-section">
        <h2>3. 预览导出内容</h2>
        <button onclick="previewExport()">预览导出内容</button>
        <div id="preview-results"></div>
    </div>
    
    <div class="test-section">
        <h2>4. 清理测试数据</h2>
        <button onclick="clearTestData()">清理数据</button>
        <div id="cleanup-results"></div>
    </div>
    
    <script src="../src/js/ebbinghaus.js"></script>
    <script src="../src/js/storage.js"></script>
    <script>
        function createTestData() {
            const results = document.getElementById('create-results');
            results.innerHTML = '<h3>创建测试数据：</h3>';
            
            try {
                // 清理现有数据
                localStorage.removeItem('my_ebbinghaus_knowledge_points');
                
                // 创建不同掌握程度的测试知识点
                const testPoints = [
                    {
                        title: '掌握的知识点',
                        content: '# 这是掌握的知识点\n\n**重点内容：**\n- 要点1\n- 要点2\n\n```javascript\nfunction example() {\n    return "Hello World";\n}\n```',
                        masteryLevel: 'mastered',
                        tags: ['测试', '掌握', '重要']
                    },
                    {
                        title: '学习中的知识点',
                        content: '## 学习中的内容\n\n这是一个正在学习的知识点，需要继续复习。\n\n**注意事项：**\n1. 注意理解概念\n2. 多做练习',
                        masteryLevel: 'learning',
                        tags: ['测试', '学习中']
                    },
                    {
                        title: '困难的知识点',
                        content: '### 困难的知识点\n\n这个知识点比较难，需要重点复习。\n\n**学习策略：**\n- 分解学习\n- 反复练习\n- 寻求帮助',
                        masteryLevel: 'struggling',
                        tags: ['测试', '困难', '重点']
                    }
                ];
                
                const createdPoints = [];
                testPoints.forEach(point => {
                    const created = addKnowledgePoint(point.title, point.content, point.tags, point.masteryLevel);
                    createdPoints.push(created);
                    results.innerHTML += `<div class="test-result info">✅ 创建：${created.title} (${created.masteryLevel})</div>`;
                });
                
                results.innerHTML += `<div class="test-result pass">✅ 成功创建 ${createdPoints.length} 个测试知识点</div>`;
                
            } catch (error) {
                results.innerHTML += `<div class="test-result fail">❌ 创建失败：${error.message}</div>`;
            }
        }
        
        function testExport() {
            const results = document.getElementById('export-results');
            results.innerHTML = '<h3>测试导出功能：</h3>';
            
            try {
                const points = getAllKnowledgePoints();
                
                if (points.length === 0) {
                    results.innerHTML += '<div class="test-result fail">❌ 没有知识点可以导出</div>';
                    return;
                }
                
                results.innerHTML += `<div class="test-result info">📊 知识点数量：${points.length}</div>`;
                
                // 模拟导出功能
                const markdown = generateTestMarkdown(points);
                
                // 创建下载链接
                const blob = new Blob([markdown], { type: 'text/markdown;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `test_export_${getTodayString()}.md`;
                link.textContent = '下载测试导出文件';
                link.style.display = 'block';
                link.style.margin = '10px 0';
                link.style.padding = '8px 16px';
                link.style.backgroundColor = '#007bff';
                link.style.color = 'white';
                link.style.textDecoration = 'none';
                link.style.borderRadius = '4px';
                
                results.appendChild(link);
                
                results.innerHTML += '<div class="test-result pass">✅ 导出功能测试成功</div>';
                
            } catch (error) {
                results.innerHTML += `<div class="test-result fail">❌ 导出测试失败：${error.message}</div>`;
            }
        }
        
        function previewExport() {
            const results = document.getElementById('preview-results');
            results.innerHTML = '<h3>预览导出内容：</h3>';
            
            try {
                const points = getAllKnowledgePoints();
                
                if (points.length === 0) {
                    results.innerHTML += '<div class="test-result fail">❌ 没有知识点可以预览</div>';
                    return;
                }
                
                const markdown = generateTestMarkdown(points);
                
                results.innerHTML += '<h4>导出的Markdown内容：</h4>';
                results.innerHTML += `<textarea readonly>${markdown}</textarea>`;
                
                results.innerHTML += '<div class="test-result pass">✅ 预览生成成功</div>';
                
            } catch (error) {
                results.innerHTML += `<div class="test-result fail">❌ 预览失败：${error.message}</div>`;
            }
        }
        
        function generateTestMarkdown(points) {
            const today = getTodayString();
            const masteryDisplayNames = {
                'mastered': '掌握',
                'learning': '学习中', 
                'struggling': '困难'
            };
            
            let markdown = `# My Ebbinghaus 知识点导出\n\n`;
            markdown += `**导出时间：** ${today}\n`;
            markdown += `**知识点数量：** ${points.length}\n\n`;
            markdown += `---\n\n`;
            
            // 按掌握程度分组
            const groupedPoints = {
                'mastered': points.filter(p => p.masteryLevel === 'mastered'),
                'learning': points.filter(p => p.masteryLevel === 'learning'),
                'struggling': points.filter(p => p.masteryLevel === 'struggling')
            };
            
            // 生成各掌握程度的知识点
            Object.keys(groupedPoints).forEach(level => {
                const levelPoints = groupedPoints[level];
                if (levelPoints.length > 0) {
                    markdown += `## ${masteryDisplayNames[level]} (${levelPoints.length}个)\n\n`;
                    
                    levelPoints.forEach((point, index) => {
                        markdown += `### ${index + 1}. ${point.title}\n\n`;
                        
                        // 基本信息
                        markdown += `**掌握程度：** ${masteryDisplayNames[point.masteryLevel]}\n`;
                        markdown += `**复习次数：** ${point.reviewCount}\n`;
                        markdown += `**创建时间：** ${point.createdAt}\n`;
                        if (point.lastReviewed) {
                            markdown += `**上次复习：** ${point.lastReviewed}\n`;
                        }
                        markdown += `**下次复习：** ${point.nextReview}\n`;
                        
                        // 标签
                        if (point.tags && point.tags.length > 0) {
                            markdown += `**标签：** ${point.tags.join(', ')}\n`;
                        }
                        
                        markdown += `\n**内容：**\n\n`;
                        markdown += `${point.content}\n\n`;
                        markdown += `---\n\n`;
                    });
                }
            });
            
            // 添加统计信息
            markdown += `## 统计信息\n\n`;
            markdown += `- **掌握：** ${groupedPoints.mastered.length} 个\n`;
            markdown += `- **学习中：** ${groupedPoints.learning.length} 个\n`;
            markdown += `- **困难：** ${groupedPoints.struggling.length} 个\n`;
            markdown += `- **总计：** ${points.length} 个\n\n`;
            
            // 添加复习提醒
            const todayPoints = points.filter(p => p.nextReview && p.nextReview <= today);
            if (todayPoints.length > 0) {
                markdown += `## 今日复习提醒\n\n`;
                markdown += `今天需要复习的知识点：\n\n`;
                todayPoints.forEach(point => {
                    markdown += `- ${point.title} (${masteryDisplayNames[point.masteryLevel]})\n`;
                });
                markdown += `\n`;
            }
            
            markdown += `---\n\n`;
            markdown += `*此文件由 My Ebbinghaus v1 自动生成*`;
            
            return markdown;
        }
        
        function clearTestData() {
            const results = document.getElementById('cleanup-results');
            results.innerHTML = '<h3>清理测试数据：</h3>';
            
            try {
                localStorage.removeItem('my_ebbinghaus_knowledge_points');
                localStorage.removeItem('my_ebbinghaus_settings');
                results.innerHTML += '<div class="test-result pass">✅ 测试数据清理完成</div>';
            } catch (error) {
                results.innerHTML += `<div class="test-result fail">❌ 清理失败：${error.message}</div>`;
            }
        }
    </script>
</body>
</html>

