<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŒæ¡ç¨‹åº¦æ”¹å˜æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .test-result { margin: 10px 0; padding: 10px; }
        .pass { background-color: #d4edda; color: #155724; }
        .fail { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button { padding: 8px 16px; margin: 5px; }
        table { border-collapse: collapse; width: 100%; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>æŒæ¡ç¨‹åº¦æ”¹å˜æµ‹è¯•</h1>
    <p>æµ‹è¯•æŒæ¡ç¨‹åº¦æ”¹å˜æ—¶å¤ä¹ æ—¥æœŸæ˜¯å¦æ­£ç¡®æ›´æ–°</p>
    
    <div class="test-section">
        <h2>1. åˆ›å»ºæµ‹è¯•çŸ¥è¯†ç‚¹</h2>
        <button onclick="createTestPoint()">åˆ›å»ºå­¦ä¹ ä¸­ç­‰çº§çš„çŸ¥è¯†ç‚¹</button>
        <div id="create-results"></div>
    </div>
    
    <div class="test-section">
        <h2>2. æ£€æŸ¥åˆå§‹å¤ä¹ æ—¶é—´</h2>
        <button onclick="checkInitialReviewTime()">æ£€æŸ¥åˆå§‹å¤ä¹ æ—¶é—´</button>
        <div id="initial-results"></div>
    </div>
    
    <div class="test-section">
        <h2>3. æ”¹å˜æŒæ¡ç¨‹åº¦</h2>
        <button onclick="changeMasteryLevel()">æ”¹ä¸ºå›°éš¾ç­‰çº§</button>
        <div id="change-results"></div>
    </div>
    
    <div class="test-section">
        <h2>4. éªŒè¯å¤ä¹ æ—¶é—´æ›´æ–°</h2>
        <button onclick="verifyReviewTimeUpdate()">éªŒè¯å¤ä¹ æ—¶é—´æ›´æ–°</button>
        <div id="verify-results"></div>
    </div>
    
    <div class="test-section">
        <h2>5. æµ‹è¯•æ‰€æœ‰æŒæ¡ç¨‹åº¦å˜åŒ–</h2>
        <button onclick="testAllMasteryChanges()">æµ‹è¯•æ‰€æœ‰å˜åŒ–</button>
        <div id="all-tests-results"></div>
    </div>
    
    <div class="test-section">
        <h2>6. æ¸…ç†æµ‹è¯•æ•°æ®</h2>
        <button onclick="clearTestData()">æ¸…ç†æ•°æ®</button>
        <div id="cleanup-results"></div>
    </div>
    
    <script src="../src/js/ebbinghaus.js"></script>
    <script src="../src/js/storage.js"></script>
    <script>
        let testPointId = null;
        
        function createTestPoint() {
            const results = document.getElementById('create-results');
            results.innerHTML = '<h3>åˆ›å»ºæµ‹è¯•çŸ¥è¯†ç‚¹ï¼š</h3>';
            
            try {
                // æ¸…ç†ç°æœ‰æ•°æ®
                localStorage.removeItem('my_ebbinghaus_knowledge_points');
                
                // åˆ›å»ºå­¦ä¹ ä¸­ç­‰çº§çš„çŸ¥è¯†ç‚¹
                const testPoint = addKnowledgePoint(
                    'æµ‹è¯•æŒæ¡ç¨‹åº¦å˜åŒ–',
                    'è¿™æ˜¯ä¸€ä¸ªç”¨äºæµ‹è¯•æŒæ¡ç¨‹åº¦å˜åŒ–çš„çŸ¥è¯†ç‚¹',
                    ['æµ‹è¯•', 'æŒæ¡ç¨‹åº¦'],
                    'learning'
                );
                
                testPointId = testPoint.id;
                
                results.innerHTML += `<div class="test-result info">âœ… åˆ›å»ºçŸ¥è¯†ç‚¹ï¼š${testPoint.title}</div>`;
                results.innerHTML += `<div class="test-result info">ğŸ“Š æŒæ¡ç¨‹åº¦ï¼š${testPoint.masteryLevel}</div>`;
                results.innerHTML += `<div class="test-result info">ğŸ“… ä¸‹æ¬¡å¤ä¹ ï¼š${testPoint.nextReview}</div>`;
                results.innerHTML += `<div class="test-result info">ğŸ†” çŸ¥è¯†ç‚¹IDï¼š${testPoint.id}</div>`;
                
            } catch (error) {
                results.innerHTML += `<div class="test-result fail">âŒ åˆ›å»ºå¤±è´¥ï¼š${error.message}</div>`;
            }
        }
        
        function checkInitialReviewTime() {
            const results = document.getElementById('initial-results');
            results.innerHTML = '<h3>æ£€æŸ¥åˆå§‹å¤ä¹ æ—¶é—´ï¼š</h3>';
            
            try {
                if (!testPointId) {
                    results.innerHTML += '<div class="test-result fail">âŒ è¯·å…ˆåˆ›å»ºæµ‹è¯•çŸ¥è¯†ç‚¹</div>';
                    return;
                }
                
                const points = getAllKnowledgePoints();
                const point = points.find(p => p.id === testPointId);
                
                if (!point) {
                    results.innerHTML += '<div class="test-result fail">âŒ æ‰¾ä¸åˆ°æµ‹è¯•çŸ¥è¯†ç‚¹</div>';
                    return;
                }
                
                const today = getTodayString();
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowStr = tomorrow.toISOString().split('T')[0];
                
                results.innerHTML += `<div class="test-result info">ğŸ“… ä»Šå¤©ï¼š${today}</div>`;
                results.innerHTML += `<div class="test-result info">ğŸ“… æ˜å¤©ï¼š${tomorrowStr}</div>`;
                results.innerHTML += `<div class="test-result info">ğŸ“Š å½“å‰æŒæ¡ç¨‹åº¦ï¼š${point.masteryLevel}</div>`;
                results.innerHTML += `<div class="test-result info">ğŸ“… å½“å‰å¤ä¹ æ—¶é—´ï¼š${point.nextReview}</div>`;
                
                // éªŒè¯å­¦ä¹ ä¸­ç­‰çº§åº”è¯¥æ˜¯æ˜å¤©å¤ä¹ 
                if (point.masteryLevel === 'learning' && point.nextReview === tomorrowStr) {
                    results.innerHTML += '<div class="test-result pass">âœ… å­¦ä¹ ä¸­ç­‰çº§æ­£ç¡®è®¾ç½®ä¸ºæ˜å¤©å¤ä¹ </div>';
                } else {
                    results.innerHTML += '<div class="test-result fail">âŒ å­¦ä¹ ä¸­ç­‰çº§å¤ä¹ æ—¶é—´è®¾ç½®é”™è¯¯</div>';
                }
                
            } catch (error) {
                results.innerHTML += `<div class="test-result fail">âŒ æ£€æŸ¥å¤±è´¥ï¼š${error.message}</div>`;
            }
        }
        
        function changeMasteryLevel() {
            const results = document.getElementById('change-results');
            results.innerHTML = '<h3>æ”¹å˜æŒæ¡ç¨‹åº¦ï¼š</h3>';
            
            try {
                if (!testPointId) {
                    results.innerHTML += '<div class="test-result fail">âŒ è¯·å…ˆåˆ›å»ºæµ‹è¯•çŸ¥è¯†ç‚¹</div>';
                    return;
                }
                
                // æ”¹å˜æŒæ¡ç¨‹åº¦ä¸ºå›°éš¾
                const success = updateKnowledgePoint(testPointId, {
                    masteryLevel: 'struggling'
                });
                
                if (success) {
                    results.innerHTML += '<div class="test-result pass">âœ… æŒæ¡ç¨‹åº¦æ›´æ–°æˆåŠŸ</div>';
                    
                    // æ£€æŸ¥æ›´æ–°åçš„çŠ¶æ€
                    const points = getAllKnowledgePoints();
                    const point = points.find(p => p.id === testPointId);
                    
                    if (point) {
                        results.innerHTML += `<div class="test-result info">ğŸ“Š æ–°æŒæ¡ç¨‹åº¦ï¼š${point.masteryLevel}</div>`;
                        results.innerHTML += `<div class="test-result info">ğŸ“… æ–°å¤ä¹ æ—¶é—´ï¼š${point.nextReview}</div>`;
                    }
                } else {
                    results.innerHTML += '<div class="test-result fail">âŒ æŒæ¡ç¨‹åº¦æ›´æ–°å¤±è´¥</div>';
                }
                
            } catch (error) {
                results.innerHTML += `<div class="test-result fail">âŒ æ›´æ–°å¤±è´¥ï¼š${error.message}</div>`;
            }
        }
        
        function verifyReviewTimeUpdate() {
            const results = document.getElementById('verify-results');
            results.innerHTML = '<h3>éªŒè¯å¤ä¹ æ—¶é—´æ›´æ–°ï¼š</h3>';
            
            try {
                if (!testPointId) {
                    results.innerHTML += '<div class="test-result fail">âŒ è¯·å…ˆåˆ›å»ºæµ‹è¯•çŸ¥è¯†ç‚¹</div>';
                    return;
                }
                
                const points = getAllKnowledgePoints();
                const point = points.find(p => p.id === testPointId);
                
                if (!point) {
                    results.innerHTML += '<div class="test-result fail">âŒ æ‰¾ä¸åˆ°æµ‹è¯•çŸ¥è¯†ç‚¹</div>';
                    return;
                }
                
                const today = getTodayString();
                
                results.innerHTML += `<div class="test-result info">ğŸ“… ä»Šå¤©ï¼š${today}</div>`;
                results.innerHTML += `<div class="test-result info">ğŸ“Š å½“å‰æŒæ¡ç¨‹åº¦ï¼š${point.masteryLevel}</div>`;
                results.innerHTML += `<div class="test-result info">ğŸ“… å½“å‰å¤ä¹ æ—¶é—´ï¼š${point.nextReview}</div>`;
                
                // éªŒè¯å›°éš¾ç­‰çº§åº”è¯¥æ˜¯å½“å¤©å¤ä¹ 
                if (point.masteryLevel === 'struggling' && point.nextReview === today) {
                    results.innerHTML += '<div class="test-result pass">âœ… å›°éš¾ç­‰çº§æ­£ç¡®è®¾ç½®ä¸ºå½“å¤©å¤ä¹ </div>';
                } else {
                    results.innerHTML += '<div class="test-result fail">âŒ å›°éš¾ç­‰çº§å¤ä¹ æ—¶é—´è®¾ç½®é”™è¯¯</div>';
                }
                
                // æ£€æŸ¥æ˜¯å¦åœ¨å½“å¤©å¤ä¹ é˜Ÿåˆ—ä¸­
                const pointsToReview = getPointsToReview();
                const inQueue = pointsToReview.some(p => p.id === testPointId);
                
                if (inQueue) {
                    results.innerHTML += '<div class="test-result pass">âœ… çŸ¥è¯†ç‚¹åœ¨å½“å¤©å¤ä¹ é˜Ÿåˆ—ä¸­</div>';
                } else {
                    results.innerHTML += '<div class="test-result fail">âŒ çŸ¥è¯†ç‚¹ä¸åœ¨å½“å¤©å¤ä¹ é˜Ÿåˆ—ä¸­</div>';
                }
                
            } catch (error) {
                results.innerHTML += `<div class="test-result fail">âŒ éªŒè¯å¤±è´¥ï¼š${error.message}</div>`;
            }
        }
        
        function testAllMasteryChanges() {
            const results = document.getElementById('all-tests-results');
            results.innerHTML = '<h3>æµ‹è¯•æ‰€æœ‰æŒæ¡ç¨‹åº¦å˜åŒ–ï¼š</h3>';
            
            try {
                // æ¸…ç†ç°æœ‰æ•°æ®
                localStorage.removeItem('my_ebbinghaus_knowledge_points');
                
                const today = getTodayString();
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowStr = tomorrow.toISOString().split('T')[0];
                
                results.innerHTML += `<div class="test-result info">ğŸ“… ä»Šå¤©ï¼š${today}</div>`;
                results.innerHTML += `<div class="test-result info">ğŸ“… æ˜å¤©ï¼š${tomorrowStr}</div>`;
                
                // æµ‹è¯•æ‰€æœ‰æŒæ¡ç¨‹åº¦å˜åŒ–
                const testCases = [
                    { from: 'struggling', to: 'learning', expected: tomorrowStr },
                    { from: 'struggling', to: 'mastered', expected: tomorrowStr },
                    { from: 'learning', to: 'struggling', expected: today },
                    { from: 'learning', to: 'mastered', expected: tomorrowStr },
                    { from: 'mastered', to: 'struggling', expected: today },
                    { from: 'mastered', to: 'learning', expected: tomorrowStr }
                ];
                
                results.innerHTML += '<table><tr><th>ä»</th><th>åˆ°</th><th>æœŸæœ›å¤ä¹ æ—¶é—´</th><th>å®é™…å¤ä¹ æ—¶é—´</th><th>ç»“æœ</th></tr>';
                
                testCases.forEach((testCase, index) => {
                    // åˆ›å»ºæµ‹è¯•çŸ¥è¯†ç‚¹
                    const testPoint = addKnowledgePoint(
                        `æµ‹è¯•${index + 1}`,
                        `æµ‹è¯•æŒæ¡ç¨‹åº¦å˜åŒ–ï¼š${testCase.from} â†’ ${testCase.to}`,
                        ['æµ‹è¯•'],
                        testCase.from
                    );
                    
                    // æ”¹å˜æŒæ¡ç¨‹åº¦
                    updateKnowledgePoint(testPoint.id, {
                        masteryLevel: testCase.to
                    });
                    
                    // æ£€æŸ¥ç»“æœ
                    const points = getAllKnowledgePoints();
                    const point = points.find(p => p.id === testPoint.id);
                    const actual = point ? point.nextReview : 'æœªçŸ¥';
                    const passed = actual === testCase.expected;
                    
                    results.innerHTML += `
                        <tr>
                            <td>${testCase.from}</td>
                            <td>${testCase.to}</td>
                            <td>${testCase.expected}</td>
                            <td>${actual}</td>
                            <td>${passed ? 'âœ…' : 'âŒ'}</td>
                        </tr>
                    `;
                });
                
                results.innerHTML += '</table>';
                
            } catch (error) {
                results.innerHTML += `<div class="test-result fail">âŒ æµ‹è¯•å¤±è´¥ï¼š${error.message}</div>`;
            }
        }
        
        function clearTestData() {
            const results = document.getElementById('cleanup-results');
            results.innerHTML = '<h3>æ¸…ç†æµ‹è¯•æ•°æ®ï¼š</h3>';
            
            try {
                localStorage.removeItem('my_ebbinghaus_knowledge_points');
                localStorage.removeItem('my_ebbinghaus_settings');
                testPointId = null;
                results.innerHTML += '<div class="test-result pass">âœ… æµ‹è¯•æ•°æ®æ¸…ç†å®Œæˆ</div>';
            } catch (error) {
                results.innerHTML += `<div class="test-result fail">âŒ æ¸…ç†å¤±è´¥ï¼š${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
